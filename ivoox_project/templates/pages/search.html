{% extends "base.html" %}

{% load i18n %}

{% block content %}
  <div class="container">
    <h1 class="my-4">{% trans "Buscar Podcast" %}</h1>
    <form method="get" action="{% url 'search' %}" class="mb-4">
      <div class="input-group">
        <input type="text"
               name="query"
               class="form-control"
               placeholder="{% trans 'Escribe tu búsqueda...' %}"
               value="{{ query }}" />
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-search"></i> {% trans "Buscar" %}
        </button>
      </div>
    </form>
    <div id="search-container" data-query="{{ query }}">
      <div id="search-status" style="display: none;">
        <div id="loading-spinner" class="text-center my-5">
          <div class="spinner-border text-primary"
               style="width: 3rem;
                      height: 3rem"
               role="status">
            <span class="visually-hidden">{% trans "Buscando..." %}</span>
          </div>
          <p id="spinner-message" class="mt-2">{% trans "Buscando..." %}</p>
        </div>
        <div id="error-message" class="alert alert-danger" style="display: none;"></div>
      </div>
      <div id="results-list" class="list-group"></div>
    </div>
  </div>
{% endblock content %}
{% block page_js %}
  <script>
    document.addEventListener("DOMContentLoaded", function() {

      // --- 1. OBTENER ELEMENTOS Y DATOS ---
      const container = document.getElementById("search-container");
      const statusContainer = document.getElementById("search-status");
      const spinner = document.getElementById("loading-spinner");
      const spinnerMessage = document.getElementById("spinner-message");
      const resultsList = document.getElementById("results-list");
      const errorMessage = document.getElementById("error-message");

      // Obtenemos el 'query' que Django puso en el HTML
      console.log(container.dataset.query);
      const query = container.dataset.query;

      // Si NO hay 'query' (página de búsqueda vacía), no hacemos nada.
      if (!query) {
        return;
      }

      // URLs de nuestras APIs
      stop()
      const dataApiUrl = `{% url 'api_search_data' %}?query=${encodeURIComponent(query)}`;
      const statusApiBaseUrl = `{% url 'api_task_status' %}`;
      const episodePageBaseUrl = `{% url 'episodes' %}`;

      // --- 2. FUNCIÓN PARA MOSTRAR RESULTADOS ---
      function renderResults(podcasts) {
        statusContainer.style.display = 'none'; // Ocultar spinner

        if (podcasts && podcasts.length > 0) {
          const fragment = document.createDocumentFragment();

          podcasts.forEach(podcast => {
            // Asumo que 'podcast' tiene: {name: '...', url: '...', thumbnail: '...'}

            // Construimos la URL para la página de episodios
            const episodeParams = new URLSearchParams({
              url: podcast.url,
              name: podcast.name
            });
            const episodeUrl = `${episodePageBaseUrl}?${episodeParams}`;

            let a = document.createElement('a');
            a.href = episodeUrl; // Enlaza a TU página de episodios
            a.className = 'list-group-item list-group-item-action d-flex align-items-center';

            let img = document.createElement('img');
            img.src = podcast.thumbnail; // Asumo que hay thumbnail
            img.className = 'me-3';
            img.style.width = '60px';
            img.alt = 'Thumbnail';
            img.loading = 'lazy';

            let titleDiv = document.createElement('div');
            titleDiv.textContent = podcast.name;

            a.appendChild(img);
            a.appendChild(titleDiv);
            fragment.appendChild(a);
          });
          resultsList.appendChild(fragment);
        } else {
          showError("{% trans 'No se encontraron podcasts para esta búsqueda.' %}");
        }
      }

      // --- 3. FUNCIÓN PARA MOSTRAR ERRORES ---
      function showError(message) {
        statusContainer.style.display = 'block'; // Muestra el contenedor de estado
        spinner.style.display = 'none'; // Oculta el spinner
        errorMessage.textContent = message;
        errorMessage.style.display = 'block'; // Muestra el error
      }

      // --- 4. FUNCIÓN DE VIGILANCIA (POLLING) ---
      // (Esta función es IDÉNTICA a la de episodes.html)
      function pollTaskStatus(taskId) {
        const statusUrl = `${statusApiBaseUrl}?task_id=${taskId}`;

        fetch(statusUrl)
          .then(response => response.json())
          .then(data => {
            if (data.status === 'SUCCESS') {
              spinnerMessage.textContent = "{% trans '¡Búsqueda completada! Cargando...' %}";
              renderResults(data.data);
            } else if (data.status === 'ERROR') {
              showError(data.message || "{% trans 'La tarea de scraping ha fallado.' %}");
            } else {
              // 'PROCESSING'
              spinnerMessage.textContent = "{% trans 'La tarea está en proceso... (puede tardar)' %}";
              setTimeout(() => pollTaskStatus(taskId), 5000); // 5 segundos
            }
          })
          .catch(error => {
            console.error("Error de red durante el polling:", error);
            showError("{% trans 'Error de red. No se puede contactar al servidor.' %}");
          });
      }

      // --- 5. INICIO: HAY UN 'QUERY', INICIAMOS LA BÚSQUEDA ---

      // Mostramos el spinner
      statusContainer.style.display = 'block';
      spinner.style.display = 'block';
      spinnerMessage.textContent = "{% trans 'Iniciando búsqueda...' %}";

      fetch(dataApiUrl)
        .then(response => {
          if (!response.ok) throw new Error("Error inicial del servidor");
          return response.json();
        })
        .then(data => {
          if (data.status === 'SUCCESS') {
            // ¡Cache HIT!
            renderResults(data.data);
          } else if (data.status === 'PROCESSING') {
            // ¡Cache MISS! Iniciamos la vigilancia (polling).
            spinnerMessage.textContent = "{% trans 'Búsqueda en curso... Esto puede tardar un momento.' %}";
            pollTaskStatus(data.task_id);
          } else {
            // Otro tipo de error
            showError(data.message || "{% trans 'Ha ocurrido un error inesperado.' %}");
          }
        })
        .catch(error => {
          console.error("Error al llamar a api_search_data:", error);
          showError("{% trans 'No se pudo iniciar la búsqueda.' %}");
        });

    });
  </script>
{% endblock page_js %}
