{% extends "base.html" %}

{% load i18n %}

{% block head_extra %}
  {# Esta es la magia: si hay una tarea, recarga la página cada 5 seg #}
  {% if task_id %}<meta http-equiv="refresh" content="5" />{% endif %}
{% endblock head_extra %}
{% block content %}
  <div class="container">
    <h1 class="my-4">{% trans "Buscar Podcast" %}</h1>
    <form method="get" action="{% url 'search' %}" class="mb-4">
      <div class="input-group">
        <input type="text"
               name="query"
               class="form-control"
               placeholder="{% trans 'Escribe tu búsqueda...' %}"
               value="{{ query }}" />
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-search"></i> {% trans "Buscar" %}
        </button>
      </div>
    </form>
    <div id="search-container">
      {% if error_message %}
        <div id="error-message" class="alert alert-danger">{{ error_message }}</div>
      {% elif task_id %}
        <div id="search-status">
          <div id="loading-spinner" class="text-center my-5">
            <div class="spinner-border text-primary"
                 style="width: 3rem;
                        height: 3rem"
                 role="status">
              <span class="visually-hidden">{% trans "Buscando..." %}</span>
            </div>
            <p id="spinner-message" class="mt-2">
              {% trans "Buscando..." %} {% trans "Esto puede tardar un momento." %}
              <br />
              <small>{% trans "La página se actualizará automáticamente." %}</small>
            </p>
          </div>
        </div>
      {% elif podcasts %}
        <div id="results-list" class="list-group">
          {% for podcast in podcasts %}
            <div class="list-group-item list-group-item-action d-flex align-items-center">
              <img src="{{ podcast.thumbnail }}"
                   class="me-3"
                   style="width: 60px"
                   alt="Thumbnail"
                   loading="lazy" />
              <a href="{% url 'episodes' %}?url={{ podcast.ivoox_url }}&name={{ podcast.name }}"
                 class="flex-grow-1">{{ podcast.name }}</a>
              <form method="post" action="{% url 'toggle_favorite' %}" class="ms-auto">
                {% csrf_token %}
                <input type="hidden" name="ivoox_id" value="{{ podcast.id }}" />
                <input type="hidden" name="name" value="{{ podcast.name }}" />
                <input type="hidden" name="ivoox_url" value="{{ podcast.ivoox_url }}" />
                <input type="hidden" name="thumbnail_url" value="{{ podcast.thumbnail }}" />
                {% if podcast.id in user_favorites_ids %}
                  <button type="submit" class="btn btn-sm btn-success">{% trans "Guardado" %}</button>
                {% else %}
                  <button type="submit" class="btn btn-sm btn-outline-primary">{% trans "Guardar" %}</button>
                {% endif %}
              </form>
            </div>
          {% endfor %}
        </div>
      {% elif query %}
        <p>{% trans 'No se encontraron podcasts para esta búsqueda.' %}</p>
      {% endif %}
    </div>
  </div>
{% endblock content %}
{% block page_js %}
  {# ¡Este bloque ahora está vacío para esta página! #}
{% endblock page_js %}
